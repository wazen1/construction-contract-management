<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Document Scanner - ERPNext</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/document_archiver/css/document_archiver.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="scanner-container">
                    <h2>Document Scanner</h2>
                    <p>Scan documents using various methods and integrate with ERPNext Document Archiver.</p>
                    
                    <!-- Scanner Selection -->
                    <div class="scanner-controls">
                        <div class="btn-group">
                            <button class="scanner-button" onclick="startWebcamScan()">
                                <i class="fas fa-camera"></i> Webcam Scan
                            </button>
                            <button class="scanner-button" onclick="startSaneScan()">
                                <i class="fas fa-scanner"></i> SANE Scanner
                            </button>
                            <button class="scanner-button" onclick="openFileUpload()">
                                <i class="fas fa-upload"></i> Upload File
                            </button>
                        </div>
                    </div>
                    
                    <!-- Webcam Interface -->
                    <div id="webcam-interface" style="display: none;">
                        <div class="webcam-preview">
                            <video id="webcam-video" width="640" height="480" autoplay style="display: none;"></video>
                            <canvas id="webcam-canvas" width="640" height="480" style="display: none;"></canvas>
                            <div id="webcam-placeholder">
                                <i class="fas fa-camera fa-3x text-muted"></i>
                                <p>Click "Start Webcam" to begin scanning</p>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="scanner-button" onclick="captureImage()" id="capture-btn" disabled>
                                <i class="fas fa-camera"></i> Capture
                            </button>
                            <button class="scanner-button" onclick="stopWebcam()">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- File Upload Interface -->
                    <div id="file-upload-interface" style="display: none;">
                        <div class="webcam-preview">
                            <input type="file" id="file-input" accept="image/*,.pdf" class="form-control">
                            <div id="file-preview" class="mt-3"></div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="scanner-button" onclick="processFileUpload()" id="upload-btn" disabled>
                                <i class="fas fa-upload"></i> Process File
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scan Settings -->
                    <div class="mt-4">
                        <h5>Scan Settings</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Quality</label>
                                <select class="form-select" id="scan-quality">
                                    <option value="Draft">Draft</option>
                                    <option value="Normal">Normal</option>
                                    <option value="High" selected>High</option>
                                    <option value="Maximum">Maximum</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Document Type</label>
                                <select class="form-select" id="document-type">
                                    <option value="Invoice">Invoice</option>
                                    <option value="Receipt">Receipt</option>
                                    <option value="Contract">Contract</option>
                                    <option value="Certificate">Certificate</option>
                                    <option value="Report">Report</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Scanner Name</label>
                                <input type="text" class="form-control" id="scanner-name" placeholder="Scanner Name">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="scan-results" class="mt-4" style="display: none;">
                        <h5>Scan Results</h5>
                        <div id="result-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <script>
        let webcamStream = null;
        let capturedImageData = null;

        function startWebcamScan() {
            document.getElementById('webcam-interface').style.display = 'block';
            document.getElementById('file-upload-interface').style.display = 'none';
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    webcamStream = stream;
                    const video = document.getElementById('webcam-video');
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('webcam-placeholder').style.display = 'none';
                    document.getElementById('capture-btn').disabled = false;
                })
                .catch(function(err) {
                    alert('Error accessing webcam: ' + err.message);
                });
        }

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            document.getElementById('webcam-interface').style.display = 'none';
            document.getElementById('webcam-video').style.display = 'none';
            document.getElementById('webcam-placeholder').style.display = 'block';
            document.getElementById('capture-btn').disabled = true;
        }

        function captureImage() {
            const video = document.getElementById('webcam-video');
            const canvas = document.getElementById('webcam-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, 640, 480);
            capturedImageData = canvas.toDataURL('image/png');
            
            // Show preview
            const preview = document.getElementById('webcam-placeholder');
            preview.innerHTML = `<img src="${capturedImageData}" style="max-width: 100%; max-height: 300px;">`;
            
            // Process the scan
            processWebcamScan();
        }

        function processWebcamScan() {
            const quality = document.getElementById('scan-quality').value;
            const documentType = document.getElementById('document-type').value;
            const scannerName = document.getElementById('scanner-name').value || 'Webcam Scanner';
            
            // Simulate API call (replace with actual API call)
            showResults({
                status: 'success',
                message: 'Document scanned successfully',
                quality: quality,
                documentType: documentType,
                scannerName: scannerName
            });
        }

        function startSaneScan() {
            // Simulate SANE scan (replace with actual API call)
            showResults({
                status: 'info',
                message: 'SANE scanning requires server-side setup. Please use the ERPNext interface.',
                scannerType: 'SANE'
            });
        }

        function openFileUpload() {
            document.getElementById('file-upload-interface').style.display = 'block';
            document.getElementById('webcam-interface').style.display = 'none';
            
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('file-preview');
                        preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 300px;">`;
                        document.getElementById('upload-btn').disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function processFileUpload() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            const quality = document.getElementById('scan-quality').value;
            const documentType = document.getElementById('document-type').value;
            const scannerName = document.getElementById('scanner-name').value || 'File Upload';
            
            // Simulate API call (replace with actual API call)
            showResults({
                status: 'success',
                message: 'File uploaded successfully',
                quality: quality,
                documentType: documentType,
                scannerName: scannerName,
                fileName: file.name
            });
        }

        function showResults(result) {
            const resultsDiv = document.getElementById('scan-results');
            const contentDiv = document.getElementById('result-content');
            
            let statusClass = 'scanner-status ';
            if (result.status === 'success') statusClass += 'success';
            else if (result.status === 'error') statusClass += 'error';
            else statusClass += 'info';
            
            contentDiv.innerHTML = `
                <div class="${statusClass}">
                    <strong>${result.message}</strong>
                </div>
                <div class="mt-3">
                    <p><strong>Scanner:</strong> ${result.scannerName || result.scannerType || 'Unknown'}</p>
                    <p><strong>Quality:</strong> <span class="quality-indicator ${result.quality?.toLowerCase()}">${result.quality || 'Unknown'}</span></p>
                    <p><strong>Document Type:</strong> ${result.documentType || 'Unknown'}</p>
                    ${result.fileName ? `<p><strong>File:</strong> ${result.fileName}</p>` : ''}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>